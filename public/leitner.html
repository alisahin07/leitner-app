<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leitner UygulamasÄ±</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 30px; background: #f4f4f9; }
    h2 { color: #333; }
    #controls { margin: 20px; }
    input, button { padding: 10px; margin: 5px; border-radius: 8px; border: 1px solid #ccc; }
    #status { margin-top: 20px; font-weight: bold; color: #444; }
    ul { text-align: left; display: inline-block; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ğŸ§ Leitner â€“ Notion</h2>

  <!-- JSON ekleme -->
  <input type="file" id="jsonFile" accept=".json">
  <button onclick="insertLinks()">ğŸ“¥ JSON Databaseâ€™e Ekle</button>
  <br><br>

  <!-- Leitner kontrolleri -->
  <div id="controls">
    <label>SÃ¼re (saniye): </label>
    <input type="number" id="duration" value="10" min="1">
    <button onclick="startLeitner()">â–¶ï¸ BaÅŸlat</button>
    <button onclick="randomLink()">ğŸ² Rastgele</button>
    <button onclick="resetToBox1()">ğŸ”„ 1. Kutuya SÄ±fÄ±rla</button>
  </div>

  <!-- SayaÃ§lar -->
  <h3>â± Ã‡alÄ±ÅŸma SÃ¼releri</h3>
  <p id="dailyLabel">BugÃ¼n: 0 saat</p>
  <p id="totalLabel">Toplam: 0 saat</p>

  <div id="status">HazÄ±r...</div>
  <ul id="todayList"></ul>

  <script>
    const BASE_URL = "https://leitner-app.onrender.com"; // ğŸŒ Render URL

    let links = [];
    let currentIndex = 0;
    let timer;
    let activePageId = null;

    // sÃ¼re Ã¶lÃ§Ã¼m iÃ§in deÄŸiÅŸkenler
    let startTime = null;
    let dailyHours = 0;
    let totalHours = 0;

    // ğŸ“Œ JSON dosyasÄ±nÄ± oku
    document.getElementById("jsonFile").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        links = JSON.parse(e.target.result);
        document.getElementById("status").innerText = `âœ… ${links.length} link yÃ¼klendi. "Databaseâ€™e Ekle" butonuna bas.`;
      };
      reader.readAsText(file);
    });

    // ğŸ“Œ JSONâ€™daki linkleri databaseâ€™e ekle
    async function insertLinks() {
      if (links.length === 0) {
        alert("âš ï¸ Ã–nce JSON dosyasÄ± seÃ§melisin!");
        return;
      }
      const today = new Date().toISOString().split("T")[0];

      for (const link of links) {
        await fetch(`${BASE_URL}/insert`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            parent: { database_id: "27c85a405d038044886bf26380697ff8" },
            properties: {
              "Title": { title: [{ text: { content: link.title } }] },
              "URL": { url: link.url },
              "Box": { number: 1 },
              "Next Review": { date: { start: today } },
              "Daily Hours": { number: 0 },
              "Total Hours": { number: 0 }
            }
          })
        });
      }
      document.getElementById("status").innerText = "âœ… JSONâ€™daki linkler databaseâ€™e eklendi!";
      await loadTodayLinks();
    }

    // ğŸ“Œ BugÃ¼nkÃ¼ linkleri getir
    async function loadTodayLinks() {
      const res = await fetch(`${BASE_URL}/query`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      });
      const data = await res.json();

      links = data.results.map(page => ({
        id: page.id,
        title: page.properties.Title.title[0]?.plain_text || "No Title",
        url: page.properties.URL.url,
        box: page.properties.Box.number,
        daily: page.properties["Daily Hours"]?.number || 0,
        total: page.properties["Total Hours"]?.number || 0
      }));

      const ul = document.getElementById("todayList");
      ul.innerHTML = "";
      links.forEach(link => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="${link.url}" target="_blank">${link.title}</a> (Kutu: ${link.box})`;
        ul.appendChild(li);
      });

      document.getElementById("status").innerText = `ğŸ“… BugÃ¼n ${links.length} link var`;
    }

    // ğŸ“Œ Dinleme baÅŸlat
    function startLeitner() {
      startTime = new Date(); // zaman Ã¶lÃ§Ã¼mÃ¼ baÅŸlasÄ±n
      currentIndex = 0;
      playNext();
    }

    function playNext() {
      const duration = parseInt(document.getElementById("duration").value) * 1000;
      if (currentIndex >= links.length) {
        document.getElementById("status").innerText = "ğŸ‰ TÃ¼m linkler aÃ§Ä±ldÄ±";
        endLeitner(); // sÃ¼reyi hesapla
        return;
      }
      const link = links[currentIndex];
      activePageId = link.id;
      document.getElementById("status").innerText = `â–¶ï¸ AÃ§Ä±lÄ±yor: ${link.title}`;
      window.open(link.url, "_blank");
      updateBox(link); // kutu gÃ¼ncelle
      currentIndex++;
      clearTimeout(timer);
      timer = setTimeout(playNext, duration);
    }

    function randomLink() {
      const duration = parseInt(document.getElementById("duration").value) * 1000;
      const randIndex = Math.floor(Math.random() * links.length);
      const link = links[randIndex];
      activePageId = link.id;
      document.getElementById("status").innerText = `ğŸ² Rastgele: ${link.title}`;
      window.open(link.url, "_blank");
      updateBox(link);
      clearTimeout(timer);
      timer = setTimeout(playNext, duration);
    }

    // ğŸ“Œ Box gÃ¼ncelle
    async function updateBox(link) {
      let newBox = (link.box || 1) + 1;
      if (newBox > 5) newBox = 5;

      const intervals = { 1: 1, 2: 2, 3: 4, 4: 8, 5: 16 };
      const nextDate = new Date();
      nextDate.setDate(nextDate.getDate() + intervals[newBox]);

      await fetch(`${BASE_URL}/update/${link.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          properties: {
            "Box": { number: newBox },
            "Next Review": { date: { start: nextDate.toISOString().split("T")[0] } }
          }
        })
      });
    }

    // ğŸ“Œ 1. kutuya sÄ±fÄ±rla
    async function resetToBox1() {
      if (!activePageId) {
        alert("âš ï¸ Ã–nce bir link aÃ§malÄ±sÄ±n");
        return;
      }
      const today = new Date().toISOString().split("T")[0];
      await fetch(`${BASE_URL}/update/${activePageId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          properties: {
            "Box": { number: 1 },
            "Next Review": { date: { start: today } }
          }
        })
      });
      document.getElementById("status").innerText = "ğŸ”„ Kart 1. kutuya sÄ±fÄ±rlandÄ±";
      await loadTodayLinks();
    }

    // ğŸ“Œ Ã‡alÄ±ÅŸma bitince sÃ¼re hesapla
    async function endLeitner() {
      const endTime = new Date();
      const diffMs = endTime - startTime;
      const diffHours = diffMs / (1000 * 60 * 60);

      dailyHours += diffHours;
      totalHours += diffHours;

      document.getElementById("dailyLabel").innerText = `BugÃ¼n: ${dailyHours.toFixed(2)} saat`;
      document.getElementById("totalLabel").innerText = `Toplam: ${totalHours.toFixed(2)} saat`;

      if (activePageId) {
        await fetch(`${BASE_URL}/update-hours/${activePageId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            daily: dailyHours,
            total: totalHours
          })
        });
      }
    }

    // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda bugÃ¼nkÃ¼ linkleri getir
    loadTodayLinks();
  </script>
</body>
</html>
